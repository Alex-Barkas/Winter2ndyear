name: Daily Agenda Email

on:
  schedule:
    # Runs at 13:00 UTC, which is 8:00 AM EST (standard time) / 9:00 AM EDT (daylight savings)
    - cron: '0 13 * * *'
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  send-email:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install firebase-admin

    - name: Create Service Account Key
      env:
        FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
      run: |
        python -c "
        import os, base64
        secret = os.environ['FIREBASE_CREDENTIALS'].strip()
        try:
            # Try to see if it's already JSON (starts with {)
            if secret.startswith('{'):
                with open('public/serviceAccountKey.json', 'w', encoding='utf-8') as f:
                    f.write(secret)
                print('Detected JSON secret. Wrote directly.')
            else:
                # Assume Base64
                decoded = base64.b64decode(secret)
                with open('public/serviceAccountKey.json', 'wb') as f:
                    f.write(decoded)
                print('Detected Base64 secret. Decoded and wrote.')
        except Exception as e:
            print(f'Error writing key: {e}')
            exit(1)
        "
        ls -l public/serviceAccountKey.json

    - name: Run Auto Email Script
      env:
        SENDER_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
        # SENDER_EMAIL and RECEIVER_EMAIL will use defaults defined in auto_email.py
        # unless you add them to secrets and uncomment below:
        # SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        # RECEIVER_EMAIL: ${{ secrets.TARGET_EMAIL }}
      run: |
        python public/auto_email.py
