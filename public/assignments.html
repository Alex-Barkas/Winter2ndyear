<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignments - Notes.</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <main class="container">
        <!-- Header -->
        <header>
            <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
            <h1 id="course-title">Assignments</h1>
            <p id="course-subtitle" class="subtitle">Upcoming deliverables and deadlines.</p>
        </header>

        <!-- Tabs -->

        <!-- Content -->
        <div class="content-stack">
            <!-- Assignment List View -->
            <section id="assignments-view">
                <h2 class="section-label">UPCOMING</h2>
                <div id="assignment-list" class="list-grid">
                    <!-- Assignments injected via JS -->
                    <p style="opacity:0.5; font-size: 0.8rem; padding: 2rem;">Loading data...</p>
                </div>
            </section>

            <!-- Grade View (Hidden by default) -->
        </div>

        <!-- Footer -->
    </main>

    <script src="student-config.js"></script>

    <script>
        // Helper to determine Semester Week
        function getSemesterWeek(dateString) {
            const d = new Date(dateString);
            const startOfSem = new Date('2026-01-05');
            const rwStart = new Date('2026-02-16');
            const rwEnd = new Date('2026-02-22');

            if (d >= rwStart && d <= rwEnd) return "Reading Week";

            const diffTime = d - startOfSem;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return "Pre-Term";

            let weekNum = Math.floor(diffDays / 7) + 1;
            if (d > rwEnd) weekNum -= 1;

            return `Week ${weekNum}`;
        }

        function createAssignmentCard(item) {
            try {
                if (!item) return '';
                const dateStr = item.date || new Date().toISOString().split('T')[0];
                const timeStr = item.time || "23:59";

                const dateObj = new Date(dateStr + 'T' + timeStr);
                const day = dateObj.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
                const weekLabel = getSemesterWeek(dateStr);
                const status = item.status || 'PENDING';

                let statusClass = "status-pending";
                if (status === 'DONE') statusClass = "status-done";
                if (status === 'UPCOMING') statusClass = "status-upcoming";

                const category = item.category || "ASSIGNMENT";
                const categoryClass = `category-${category.toLowerCase()}`;

                const showStatus = status !== 'PENDING' && status !== 'UPCOMING';
                const statusHtml = showStatus ? `<span class="assign-status ${statusClass}">${status}</span>` : '';

                return `
                    <a href="details.html?id=${item.id}" class="assignment-item">
                        <div class="assign-left">
                            <span class="assign-date">
                                ${day}
                                <div style="font-size: 0.65rem; opacity: 0.6; margin-top: 2px;">${weekLabel}</div>
                            </span>
                            <div class="assign-details">
                                <div class="assign-meta">
                                    <span class="assign-course">${item.course || "Unknown Course"}</span>
                                    <span class="assign-category ${categoryClass}">${category}</span>
                                </div>
                                <span class="assign-title">${item.title || "Untitled Assignment"}</span>
                            </div>
                        </div>
                        <div class="assign-right">
                            <span class="assign-time">${timeStr}</span>
                            ${statusHtml}
                        </div>
                    </a>
                `;
            } catch (e) {
                console.error("Error creating card for item:", item, e);
                return `<div style="color:red; padding:10px;">Error loading assignment: ${e.message}</div>`;
            }
        }

        function render(items) {
            const container = document.getElementById('assignment-list');
            if (items.length === 0) {
                container.innerHTML = `<p class="subtitle" style="grid-column: 1/-1; text-align: center; padding: 2rem;">No assignments found for this course.</p>`;
                return;
            }
            const sorted = items.sort((a, b) => new Date(a.date) - new Date(b.date));
            container.innerHTML = sorted.map(createAssignmentCard).join('');
        }

        (async function init() {
            try {
                const module = await import('./data-service.js');
                const DataService = module.DataService;


                const urlParams = new URLSearchParams(window.location.search);
                const courseCode = urlParams.get('course');

                const allAssignments = await DataService.getAllAssignments();

                if (courseCode) {
                    const decodedCode = decodeURIComponent(courseCode);
                    document.getElementById('course-title').innerText = `${decodedCode} Assignments`;
                    const subtitle = document.getElementById('course-subtitle');
                    if (subtitle) subtitle.innerText = `Track deadlines for ${decodedCode}`;

                    if (allAssignments) {
                        const filtered = allAssignments.filter(a => a.course === decodedCode);
                        render(filtered);
                    } else {
                        render([]);
                    }
                } else {
                    document.getElementById('course-title').innerText = "All Assignments";
                    render(allAssignments || []);
                }
            } catch (err) {
                console.error("Init Error:", err);
                const list = document.getElementById('assignment-list');
                if (list) list.innerHTML = `<div style="color:red;padding:2rem;text-align:center;">Error loading data. Please try refreshing the page.</div>`;
            }
        })();
    </script>
</body>

</html>